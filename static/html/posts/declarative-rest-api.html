<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Guseyn">
    <meta name="description" content="This blog is mostly expression of my ideas on different things in programming and IT culture">
    <meta name="keywords" content="guseyn, fan of yours, blog, IT, programming, coding, tech, culture, ideas, declarative, rest, api, library, oop, node, async objects">
    <meta name="google-site-verification" content="vGxE5xshQhWEvbfiGVWZ4qmfLx_1WW8P82ZW0RP0mwg">
    <title>fan of yours</title>
    <link rel="shortcut icon" type="image/png" href="/../image/favicon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400i,700,700i|Source+Sans+Pro:400,400i,700,700i" type="text/css">
    <link rel="stylesheet" href="/../css/normalize.css?v=1.0.77" type="text/css">
    <link rel="stylesheet" href="/../css/main.css?v=1.0.77" type="text/css">
    <link rel="stylesheet" href="/../css/main-night.css?v=1.0.77" disabled id="main-night" type="text/css">
    <link rel="stylesheet" href="/../css/github-gist.css?v=1.0.77" type="text/css">
    <link rel="stylesheet" href="/../css/github-gist-night.css?v=1.0.77" disabled id="github-gist-night" type="text/css">
    <script src="/../js/mainBundle.min.js?v=1.0.77" type="text/javascript"></script>
    <script src="/../js/highlight.pack.js?v=1.0.77" type="text/javascript"></script>
    <script src="/../js/youtube.js?v=1.0.77" type="text/javascript"></script>
    <script src="/../js/iframe.js?v=1.0.77" type="text/javascript"></script>
  </head>

  <body class="main">
    <div class="base">
      <div class="menu">
        <a href="/../stuff/about?v=1.0.77">About</a>
        <a href="/../stuff/projects?v=1.0.77">Projects</a>
        <a href="/../previews/1?v=1.0.77">Posts</a>
        <a href="/../stuff/slides?v=1.0.77">Slides</a>
        <a href="/../stuff/papers?v=1.0.77">Papers</a>
        <a href="/../stuff/talks?v=1.0.77">Talks</a>
        <a href="/../stuff/podcasts?v=1.0.77" style="display: none;">Podcasts</a>
        <a href="/../stuff/covers?v=1.0.77">â™« Covers</a>
      </div>
      <div class="day-night" id="day-night"></div>
      <div class="content">
        <h1 id="declarativerestapi">Declarative REST API</h1>
        <div class="date">16 June 2018</div>
        <div class="tags">
          <a class="tag" href="/../tags/library?v=1.0.77">library</a>
          <a class="tag" href="/../tags/oop?v=1.0.77">OOP</a>
          <a class="tag" href="/../tags/node?v=1.0.77">Node</a>
          <a class="tag" href="/../tags/asyncobjects?v=1.0.77">Async Objects</a>
        </div>
        <p>We all are used to MVC for building REST applications. In this article, I'll show how you can build REST API using object-oriented approach. It'll be demonstrated on my library <strong><a href="https://github.com/Guseyn/cutie-rest">cutie-rest</a></strong> which was released recently.</p>
        <p>Let's start with interface <strong>Endpoint</strong> and some default built-in implementations of this interface that this library provides.</p>
        <p><br />
          <strong><code>Endpoint(regexpUrl, method(string)[, ...args])</code></strong></p>
        <p>This interface declares an endpoint (in api) with <code>url</code> that matches <code>regexpUrl</code> and specified <code>method</code> (<code>'GET'</code>, <code>'POST'</code>, etc.) in arguments of constructor. Also it's possible to pass some custom arguments via <code>...args</code>. This class has a method <code>body(request, response[, ...args])</code> that needs to be overridden and must return async object.</p>
        <p>It's important to mention that <code>Endpoint</code> is not an <code>AsyncObject</code>. That's how you can implement an <code>Endpoint</code>:</p>
        <pre><code class="js language-js">const { Endpoint } = require('@cuties/rest')
const {
  ResponseWithHeader,
  ResponseWithStatusCode,
  ResponseWithStatusMessage,
  WrittenResponse,
  EndedResponse
} = require('@cuties/http')

class CustomEndpoint extends Endpoint {
  constructor (regexpUrl, type) {
    super(regexpUrl, type)
  }

  body (request, response) {
    return new EndedResponse(
      new WrittenResponse(
        new ResponseWithHeader(
          new ResponseWithStatusMessage(
            new ResponseWithStatusCode(response, 200), 'Ok'
          ),
          'Content-Type', 'text/plain'
        ),
        'Index.'
      )
    )
  }
}
</code></pre>
        <p>To handle <code>request</code> and <code>response</code> in the method <code>body</code> you can use <a href="https://github.com/Guseyn/cutie-http">cutie-http</a>.</p>
        <p><br />
          <strong><code>NotFoundEndpoint(regexpUrl)</code></strong></p>
        <p>This interface (or abstract class) extends <code>Endpoint</code>, and it declares endpoint on <strong><code>404(NOT_FOUND)</code></strong> status. </p>
        <p>And that's how it's implmented:</p>
        <pre><code class="js language-js">const { Endpoint } = require('@cuties/rest')
const {
  ResponseWithHeader,
  ResponseWithStatusCode,
  ResponseWithStatusMessage,
  WrittenResponse,
  EndedResponse
} = require('@cuties/http')

class NotFoundEndpoint extends Endpoint {
  constructor (regexpUrl) {
    super(regexpUrl, 'GET')
  }

  body (request, response) {
    return new EndedResponse(
      new WrittenResponse(
        new ResponseWithHeader(
          new ResponseWithStatusMessage(
            new ResponseWithStatusCode(response, 404), 'Not found'
          ),
          'Content-Type', 'text/plain'
        ),
        '404: Not found'
      )
    )
  }
}
</code></pre>
        <p>You can create your custom variation of <code>Endpoint</code>. Just extends this default class with redefined method <code>body</code>.</p>
        <p><br />
          <strong><code>IndexEndpoint()</code></strong></p>
        <p>It's an <code>Endpoint</code> that is used for representing index page.</p>
        <pre><code class="js language-js">const { Endpoint } = require('@cuties/rest')
const {
  ResponseWithHeader,
  ResponseWithStatusCode,
  ResponseWithStatusMessage,
  WrittenResponse,
  EndedResponse
} = require('@cuties/http')

class IndexEndpoint extends Endpoint {
  constructor () {
    super(new RegExp(/^(\/|)$/), 'GET')
  }

  body (request, response) {
    return new EndedResponse(
      new WrittenResponse(
        new ResponseWithHeader(
          new ResponseWithStatusMessage(
            new ResponseWithStatusCode(response, 200), 'Ok'
          ),
          'Content-Type', 'text/plain'
        ),
        'Index.'
      )
    )
  }
}
</code></pre>
        <p><br />
          <strong><code>InternalServerErrorEndpoint(regexpUrl)</code></strong></p>
        <p>It's an <code>Endpoint</code> that is used for handling underlying internal failure(not for user error) with status code <strong><code>500</code></strong>.</p>
        <pre><code class="js language-js">const { Endpoint } = require('@cuties/rest')
const {
  ResponseWithHeader,
  ResponseWithStatusCode,
  ResponseWithStatusMessage,
  WrittenResponse,
  EndedResponse
} = require('@cuties/http')

class InternalServerErrorEndpoint extends Endpoint {
  constructor (regexpUrl) {
    super(regexpUrl || new RegExp(/^\/internal-server-error/))
  }

  body (request, response, error) {
    return new EndedResponse(
      new WrittenResponse(
        new ResponseWithHeader(
          new ResponseWithStatusMessage(
            new ResponseWithStatusCode(response, 500), 'Internal Server Error'
          ),
          'Content-Type', 'text/plain'
        ),
        `500: Internal Server Error, \n${error}`
      )
    )
  }
}
</code></pre>
        <p>Here method <code>body</code> also handles an <code>error</code>.</p>
        <p>Now let's talk about other objects that REST API declaration consists of: <code>Backend</code>, <code>RestApi</code>, <code>RequestBody</code>, <code>CreatedServingFilesEndpoint</code>, <code>CreatedCachedServingFilesEndpoint</code>, <code>ServingFiles</code>, and <code>CachedServingFiles</code>.</p>
        <p>Let's take a look on a simple declaration of REST API.</p>
        <pre><code class="js language-js">const {
  Backend,
  RestApi,
  CreatedServingFilesEndpoint,
  CreatedCachedServingFilesEndpoint
} = require('@cuties/rest');
const path = require('path')
const SimpleResponseOnGETRequest = require('./SimpleResponseOnGETRequest')
const SimpleResponseOnPOSTRequest = require('./SimpleResponseOnPOSTRequest')
const CustomNotFoundEndpoint = require('./CustomNotFoundEndpoint')
const CustomInternalServerErrorEndpoint = require('./CustomInternalServerErrorEndpoint')
const CustomIndexEndpoint = require('./example/CustomIndexEndpoint')
const notFoundEndpoint = new CustomNotFoundEndpoint(new RegExp(/\/not-found/))
const internalServerErrorEndpoint = new CustomInternalServerErrorEndpoint(new RegExp(/^\/internal-server-error/))

const mapper = (url) =&gt; {
  let parts = url.split('/').filter(part =&gt; part !== '')
  return path.join(...parts)
}

const cacheMapper = (url) =&gt; {
  let parts = url.split('/').filter(part =&gt; part !== '').slice(1)
  parts.unshift('files')
  return path.join(...parts)
}

new Backend(
  'http', 
  8000, 
  '127.0.0.1',
  new RestApi(
    new CustomIndexEndpoint(),
    new SimpleResponseOnGETRequest(new RegExp(/^\/get/), 'GET'),
    new SimpleResponseOnPOSTRequest(new RegExp(/^\/post/), 'POST'),
    new CreatedServingFilesEndpoint(new RegExp(/^\/files/), mapper, {}, notFoundEndpoint),
    new CreatedCachedServingFilesEndpoint(new RegExp(/^\/cached/), cacheMapper, {}, notFoundEndpoint),
    notFoundEndpoint,
    internalServerErrorEndpoint
  )
).call()
</code></pre>
        <p><br />
          <strong><code>Backend(protocol, port, host, api[, options])</code></strong></p>
        <p>It's an <code>AsyncObject</code>. It declares a backend server with <code>protocol</code> (<em>http</em> or <em>https</em>) on specified <code>port</code> and <code>host</code>, also it provides declared <code>api</code>, <code>options</code> of the <em>http/https</em> server (it's optional).</p>
        <p><br />
          <strong><code>RestApi(...endpoints)</code></strong></p>
        <p>Represents request-response listener. Declares endpoints of api.</p>
        <p><br />
          <strong><code>RequestBody(request)</code></strong></p>
        <p>Reads body of request in <code>body(request, response)</code> method of <code>Endpoint</code> implementation.</p>
        <p><br />
          <strong><code>ServingFilesEndpoint(regexpUrl, mapper, headers, notFoundEndpoint)</code></strong></p>
        <p>Extends <code>Endpoint</code> and serves files on url that mathes <code>regexpUrl</code> with <code>mapper</code> function that gets location of a file on a disk by the url of incoming request. Also it's required to declare <code>notFoundEndpoint</code> that handles the cases when a file is not found. You also can specify headers in response(no need to specify the <code>'Content-Type'</code>, library makes it for you).</p>
        <p><br />
          <strong><code>CachedServingFilesEndpoint(regexpUrl, mapper, headers, notFoundEndpoint)</code></strong></p>
        <p>Does the same that <code>ServingFilesEndpoint</code> does and caches files for increasing speed of serving them.</p>
        <p><br />
          <strong><code>CreatedServingFilesEndpoint(regexpUrl, mapper, headers, notFoundEndpoint)</code></strong></p>
        <p>It's an <code>AsyncObject</code> that represents <code>ServingFilesEndpoint</code>. So, you can use its arguments as async objects.</p>
        <p><br />
          <strong><code>CreatedServingFilesEndpoint(regexpUrl, mapper, headers, notFoundEndpoint)</code></strong></p>
        <p>It's an <code>AsyncObject</code> that represents <code>CachedServingFilesEndpoint</code>. So, you can use its arguments as async objects.</p>
        <p>Let's see how endpoints are implemented.</p>
        <p><br />
          <strong><code>CustomIndexEndpoint</code></strong></p>
        <pre><code class="js language-js">class CustomIndexEndpoint extends IndexEndpoint {
  constructor () {
    super()
  }

  body (request, response) {
    return super.body(request, response)
  }
}
</code></pre>
        <p><br />
          <strong><code>CustomNotFoundEndpoint</code></strong></p>
        <pre><code class="js language-js">class CustomNotFoundEndpoint extends NotFoundEndpoint {
  constructor (regexpUrl) {
    super(regexpUrl)
  }

  body (request, response) {
    return super.body(request, response)
  }
}
</code></pre>
        <p><br />
          <strong><code>SimpleResponseOnGETRequest</code></strong></p>
        <pre><code class="js language-js">class SimpleResponseOnGETRequest extends Endpoint {
  constructor (regexpUrl, type) {
    super(regexpUrl, type)
  }

  body (request, response) {
    return new EndedResponse(
      new WrittenResponse(
        new ResponseWithWrittenHead(
          response, 200, 'ok', {
            'Content-Type': 'text/plain'
          }
        ), 'content'
      ), ' is delivered'
    )
  }
}
</code></pre>
        <p><br />
          <strong><code>SimpleResponseOnPOSTRequest</code></strong></p>
        <pre><code class="js language-js">class SimpleResponseOnPOSTRequest extends Endpoint {
  constructor (regexpUrl, type) {
    super(regexpUrl, type)
  }

  body (request, response) {
    // request also contains body(as buffer), use RequestBody object for that
    return new EndedResponse(
      new WrittenResponse(
        new ResponseWithWrittenHead(
          response, 200, 'ok', {
            'Content-Type': 'text/plain'
          }
        ), new RequestBody(request)
      ), ' is delivered'
    )
  }
}
</code></pre>
        <p><br />
          <strong><code>CustomInternalServerErrorEndpoint</code></strong></p>
        <pre><code class="js language-js">class CustomInternalServerErrorEndpoint extends InternalServerErrorEndpoint {
  constructor (regexpUrl) {
    super(regexpUrl)
  }

  body (request, response, error) {
    return super.body(request, response, error)
  }
}
</code></pre>
        <p>So, here is some examples of requests:</p>
        <pre><code class="bash language-bash">curl http://127.0.0.1:8000/
# Index.

curl http://127.0.0.1:8000/get
# content is delivered

curl -X POST  http://127.0.0.1:8000/post -d "content"
# content is delivered

curl http://127.0.0.1:8000/bad-url
# 404: Not found
</code></pre>
        <div class="refs">References</div>
        <ul>
          <li><a href="https://github.com/Guseyn/cutie-rest">cutie-rest on GitHub</a></li>
        </ul>
      </div>
      <script>
        hljs.initHighlightingOnLoad()
        initYoutubeVideos(1.777)
        makeIframesResizable('youtube-video', 1.777)
        makeIframesResizable('soundcloud', 2.185)
      </script>
    </div>
  </body>

</html>
